---
import Layout from "../components/Layout.astro";
import morse from "../data/morse.json";

const title = "Text to Morse Translator – Copy & Convert Instantly";
const description =
  "Translate text to Morse code or decode Morse to text. Copy results instantly. Free online tool.";

// IMPORTANT: Convert the imported JSON into a plain JS object string safely.
const MORSE_MAP_JSON = JSON.stringify(morse);
---

<Layout title={title} description={description}>
  <h1>Text to Morse Translator</h1>
  <p>Paste text, convert to Morse, decode Morse back to text, and copy the result.</p>

  <section class="card">
    <div class="grid">
      <div>
        <label for="mcg-input"><strong>Input</strong></label><br />
        <textarea id="mcg-input" rows="7" placeholder="Type text or Morse here..."></textarea>

        <div style="margin-top: 10px; display:flex; gap:10px; flex-wrap:wrap;">
          <button id="mcg-text-to-morse" type="button">Text → Morse</button>
          <button id="mcg-morse-to-text" type="button">Morse → Text</button>
          <button id="mcg-copy" type="button">Copy output</button>
        </div>

        <p class="muted" style="margin-top: 10px;">
          Morse tips: spaces separate characters, and “/” separates words.
        </p>
      </div>

      <div>
        <label for="mcg-output"><strong>Output</strong></label><br />
        <textarea id="mcg-output" rows="7" placeholder="Result appears here..."></textarea>
      </div>
    </div>
  </section>

  <p>
    Next: <a href="/morse-code/a/">learn the alphabet</a> or <a href="/phrases/sos/">common phrases</a>.
  </p>

  <script is:inline>
    // Build-time injected Morse map (stable on static hosts)
    const CHAR_TO_MORSE = /** @type {Record<string,string>} */ (JSON.parse({JSON.stringify(MORSE_MAP_JSON)}));
    const MORSE_TO_CHAR = Object.fromEntries(
      Object.entries(CHAR_TO_MORSE).map(([k, v]) => [v, k])
    );

    function norm(s) {
      return (s || "").toUpperCase();
    }

    function textToMorse(input) {
      const s = norm(input).trim();
      if (!s) return "";
      const words = s.split(/\s+/).filter(Boolean);

      return words
        .map((w) =>
          w
            .split("")
            .map((ch) => CHAR_TO_MORSE[ch] || "")
            .filter(Boolean)
            .join(" ")
        )
        .join(" / ");
    }

    function morseToText(input) {
      const s = (input || "").trim();
      if (!s) return "";

      const words = s.split(/\s*\/\s*/).filter(Boolean);
      return words
        .map((w) =>
          w
            .trim()
            .split(/\s+/)
            .map((code) => MORSE_TO_CHAR[code] || "")
            .join("")
        )
        .join(" ");
    }

    async function copyToClipboard(text) {
      const t = text || "";
      try {
        await navigator.clipboard.writeText(t);
        return true;
      } catch {
        // Fallback
        const ta = document.createElement("textarea");
        ta.value = t;
        document.body.appendChild(ta);
        ta.select();
        try { document.execCommand("copy"); } catch {}
        document.body.removeChild(ta);
        return true;
      }
    }

    function bindTranslator() {
      const input = document.getElementById("mcg-input");
      const output = document.getElementById("mcg-output");
      const btnT2M = document.getElementById("mcg-text-to-morse");
      const btnM2T = document.getElementById("mcg-morse-to-text");
      const btnCopy = document.getElementById("mcg-copy");

      if (!input || !output || !btnT2M || !btnM2T || !btnCopy) return;

      btnT2M.addEventListener("click", () => {
        output.value = textToMorse(input.value);
      });

      btnM2T.addEventListener("click", () => {
        output.value = morseToText(input.value);
      });

      btnCopy.addEventListener("click", async () => {
        await copyToClipboard(output.value);
        const old = btnCopy.textContent;
        btnCopy.textContent = "Copied ✓";
        setTimeout(() => (btnCopy.textContent = old), 900);
      });
    }

    // Ensure DOM is ready (prevents "handlers not attached" issues)
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", bindTranslator);
    } else {
      bindTranslator();
    }
  </script>
</Layout>
